{% extends 'base.html' %}
{% block title %}{{ _('Pretraga vozaƒça') }}{% endblock %}

{% block content %}
<div class="container">
  <!-- Statistika zaposlenih i nezaposlenih vozaƒça -->
{% if total_drivers > 0 %}
<div class="section-box mx-auto max-w-800 text-center mb-5">
  <h4 class="section-title text-shadow mb-4">
    üìä {{ _("Status vozaƒça u sistemu") }}
  </h4>

  <div class="d-flex justify-content-center align-items-center gap-4 flex-wrap">
    <div class="position-relative" style="width: 180px; height: 180px;">
      <svg viewBox="0 0 36 36" class="circular-chart" style="width: 100%; height: 100%;">
        <path class="circle-bg"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"
              fill="none"
              stroke="#eee"
              stroke-width="2.8"/>
        <path class="circle"
              stroke="#28a745"
              stroke-dasharray="{{ (total_employed / total_drivers * 100)|round(1) }}, 100"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"
              fill="none"
              stroke-width="2.8"
              stroke-linecap="round"/>
        <text x="18" y="20.35" class="percentage" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">
          {{ (total_employed / total_drivers * 100)|round(0) }}%
        </text>
      </svg>
      <div class="fw-bold mt-2 text-success">{{ _("Zaposleni") }}</div>
    </div>

    <div class="position-relative" style="width: 180px; height: 180px;">
      <svg viewBox="0 0 36 36" class="circular-chart" style="width: 100%; height: 100%;">
        <path class="circle-bg"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"
              fill="none"
              stroke="#eee"
              stroke-width="2.8"/>
        <path class="circle"
              stroke="#dc3545"
              stroke-dasharray="{{ (total_unemployed / total_drivers * 100)|round(1) }}, 100"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"
              fill="none"
              stroke-width="2.8"
              stroke-linecap="round"/>
        <text x="18" y="20.35" class="percentage" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">
          {{ (total_unemployed / total_drivers * 100)|round(0) }}%
        </text>
      </svg>
      <div class="fw-bold mt-2 text-danger">{{ _("Nezaposleni") }}</div>
    </div>
  </div>
</div>
{% endif %}

  <!-- Sekcija za pretragu -->
  <div class="section-box mx-auto max-w-800">
    <h2 class="text-center section-title text-shadow">
      üîç {{ _('Pretraga vozaƒça') }}
    </h2>

    <form method="POST" action="{{ url_for('main.search_driver') }}" class="row gx-2 gy-2 justify-content-center">
      <div class="col-12 col-md-10">
        <label for="search_input" class="form-label fw-bold text-shadow">
          {{ _('Unesite JMBG, broj tahograf kartice ili CPC kartice') }}
        </label>
        <div class="input-group shadow">
          <input type="text" id="search_input" name="search_input"
                 class="form-control"
                 placeholder="{{ _('Unesite podatke') }}"
                 required>
          <button class="btn btn-custom fw-bold" type="submit">
            <i class="fas fa-search me-1"></i> {{ _('Pretra≈æi') }}
          </button>
        </div>
      </div>
    </form>
  </div>

  {% if driver %}
  <!-- Rezultati pretrage -->
  <div class="section-box mx-auto max-w-900">
    <h4 class="text-center mb-4 section-title text-shadow">
      üìã {{ _('Rezultati pretrage') }}
    </h4>
    <hr class="divider">

    <div class="row gy-3">
      <div class="col-md-6">
        <span class="text-custom fw-bold text-shadow">{{ _('Ime i prezime:') }}</span><br>
        <a href="{{ url_for('main.driver_detail', driver_id=driver.id) }}" 
           class="text-custom driver-link fw-bold" 
           title="{{ _('Pogledaj detalje o vozaƒçu') }} {{ driver.full_name }}">
          {{ driver.full_name }}
          <i class="fas fa-arrow-right ms-1" aria-hidden="true"></i>
        </a>
        <div class="small text-white">{{ _('Kliknite za detalje') }}</div>
      </div>

      {% set active_card = driver.cards | selectattr('is_active') | first %}
      <div class="col-md-6">
        <span class="text-custom fw-bold text-shadow">{{ _('Broj tahograf kartice:') }}</span><br>
        {{ active_card.card_number if active_card else '‚Äî' }}
      </div>

      <div class="col-md-6">
        <span class="text-custom fw-bold text-shadow">{{ _('Broj CPC kartice:') }}</span><br>
        {{ driver.cpc_card_number or '‚Äî' }}
      </div>

      <div class="col-md-6">
        <span class="text-custom fw-bold text-shadow">{{ _('Firma:') }}</span><br>
        {{ driver.employer.company_name if driver.employer else _('Nije zaposlen') }}
      </div>

      <div class="col-md-6">
        <span class="text-custom fw-bold text-shadow">{{ _('Status:') }}</span><br>
        {% if driver.active %}
          <span class="badge bg-success">{{ _('Aktivan') }}</span>
        {% else %}
          <span class="badge bg-secondary">{{ _('Neaktivan') }}</span>
        {% endif %}
      </div>
    </div>

    {% if driver.cards|length > 1 %}
      <hr class="divider my-4">
      <h6 class="mb-3 text-custom text-shadow">üóÇ {{ _('Istorija tahograf kartica') }}</h6>
      <ul class="list-group list-group-flush">
        {% for card in driver.cards if not card.is_active %}
          <li class="list-group-item bg-dark text-light">
            <span class="fw-bold">{{ _('Broj kartice:') }}</span> {{ card.card_number }} ‚Äî
            {% if card.issue_date %}
              <span class="fw-bold">{{ _('Izdata:') }}</span> {{ card.issue_date.strftime('%d.%m.%Y') }},
            {% endif %}
            {% if card.expiry_date %}
              <span class="fw-bold">{{ _('Va≈æi do:') }}</span> {{ card.expiry_date.strftime('%d.%m.%Y') }}
            {% endif %}
            <span class="badge bg-secondary ms-2">{{ _('neaktivna') }}</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if already_employed_by_other %}
      <a href="{{ url_for('main.update_driver', driver_id=driver.id) }}" class="btn btn-warning mt-4">{{ _('A≈æuriraj vozaƒça') }}</a>
    {% endif %}

    {% if not driver.active %}
      <form action="{{ url_for('main.adopt_driver', driver_id=driver.id) }}" method="POST" class="mt-3">
        <button type="submit" class="btn btn-success">‚úÖ {{ _('Preuzmi vozaƒça') }}</button>
      </form>
    {% endif %}
  </div>

  {% if ratings_info %}
    <!-- Ocene -->
    <div class="section-box mx-auto max-w-900">
      <h5 class="text-center mb-3 section-title text-shadow">
        ‚≠ê {{ _('Ocene prethodnih poslodavaca') }}
      </h5>
      <div class="table-responsive shadow">
        <table class="table table-bordered table-hover align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>{{ _('Poslodavac') }}</th>
              <th>{{ _('Ocena') }}</th>
              <th>{{ _('Komentar') }}</th>
              <th>{{ _('Datum') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in ratings_info %}
            <tr>
              <td>{{ r.employer_name }}</td>
              <td>{{ r.stars }}</td>
              <td>{{ r.comment }}</td>
              <td>{{ r.rated_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p class="text-muted mt-3 text-center">{{ _('Nema ocena.') }}</p>
  {% endif %}

  {% elif request.method == 'POST' %}
    <!-- Vozaƒç nije pronaƒëen -->
    <div class="alert alert-warning text-center mt-4">‚ö†Ô∏è {{ _('Vozaƒç nije pronaƒëen.') }}</div>
  {% endif %}
</div>
{% endblock %}
