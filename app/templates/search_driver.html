{% extends 'base.html' %}
{% block title %}Pretraga vozaƒça{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg rounded-4 p-4 border-0">
        <h2 class="text-center mb-2">üîç Pretraga vozaƒça</h2>
        <p class="text-center text-muted mb-4">
          Unesite <strong>JMBG</strong>, <strong>tahograf karticu</strong> ili <strong>CPC broj</strong>
        </p>
        <form method="POST" action="{{ url_for('main.search_driver') }}">
          <div class="input-group input-group-lg">
            <input type="text" id="search_input" name="search_input" class="form-control rounded-start-pill" placeholder="Npr: 1234567890123" required>
            <button class="btn btn-primary rounded-end-pill" type="submit">
              <i class="fas fa-search me-2"></i> Pretra≈æi
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% if driver %}
  <div class="row justify-content-center mt-5">
    <div class="col-lg-10">
      <div class="card shadow-sm border-0 rounded-4 p-4 animate__animated animate__fadeIn">
        <h4 class="mb-4 border-bottom pb-2">üßæ Rezultati pretrage</h4>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Ime i prezime:</strong> {{ driver.full_name }}</li>
          {% set active_card = driver.cards | selectattr('is_active') | first %}
          <li class="list-group-item"><strong>Broj tahograf kartice:</strong> {{ active_card.card_number if active_card else '‚Äî' }}</li>
          <li class="list-group-item"><strong>Broj CPC kartice:</strong> {{ driver.cpc_card_number if driver.cpc_card_number else '‚Äî' }}</li>
          <li class="list-group-item"><strong>CPC va≈æi do:</strong> {{ driver.cpc_expiry_date.strftime('%d.%m.%Y') if driver.cpc_expiry_date else '‚Äî' }}</li>
          <li class="list-group-item"><strong>Firma:</strong> {{ driver.employer.company_name if driver.employer else 'Nije zaposlen' }}</li>
          <li class="list-group-item"><strong>Status:</strong>
            {% if driver.active %}
              <span class="badge bg-success">Aktivan</span>
            {% else %}
              <span class="badge bg-secondary">Neaktivan</span>
            {% endif %}
          </li>
        </ul>

        {% if driver.cards|length > 1 %}
        <div class="mt-4">
          <h6>üìÑ Istorija tahograf kartica</h6>
          <ul class="list-group small">
            {% for card in driver.cards if not card.is_active %}
            <li class="list-group-item">
              {{ card.card_number }} ‚Äì 
              {% if card.issue_date %} izdata: {{ card.issue_date.strftime('%d.%m.%Y') }}, {% endif %}
              {% if card.expiry_date %} va≈æi do: {{ card.expiry_date.strftime('%d.%m.%Y') }}{% endif %}
              <span class="text-muted">(neaktivna)</span>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if driver and already_employed_by_other %}
        <a href="{{ url_for('main.update_driver', driver_id=driver.id) }}" class="btn btn-warning mt-4 w-100">
          A≈æuriraj vozaƒça
        </a>
        {% endif %}

        {% if not driver.active %}
        <form action="{{ url_for('main.adopt_driver', driver_id=driver.id) }}" method="POST" class="mt-3">
          <button type="submit" class="btn btn-success w-100">Preuzmi vozaƒça</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  {% if ratings_info %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-10">
      <div class="card shadow-sm border-0 rounded-4 p-4">
        <h5 class="mb-3">‚≠ê Ocene prethodnih poslodavaca</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Poslodavac</th>
                <th>Ocena</th>
                <th>Komentar</th>
                <th>Datum</th>
              </tr>
            </thead>
            <tbody>
              {% for r in ratings_info %}
              <tr>
                <td>{{ r.employer_name }}</td>
                <td>{{ r.stars }} / 5</td>
                <td>{{ r.comment }}</td>
                <td>{{ r.rated_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <p class="text-muted text-center mt-3">Nema ocena za ovog vozaƒça.</p>
  {% endif %}

  {% elif request.method == 'POST' %}
  <div class="alert alert-warning mt-5 text-center col-md-8 mx-auto">
    Vozaƒç nije pronaƒëen.
  </div>

  {% if show_additional_fields %}
  <div class="row justify-content-center mt-4">
    <div class="col-md-6">
      <div class="card p-4 shadow-sm border-0">
        <h5 class="mb-3">üîÑ Dodatna provera</h5>
        <form method="POST" action="{{ url_for('main.search_driver') }}">
          <input type="hidden" name="check_additional" value="1">
          <div class="mb-3">
            <label for="full_name" class="form-label">Ime i prezime</label>
            <input type="text" id="full_name" name="full_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="cpc_card_number" class="form-label">Broj CPC kartice</label>
            <input type="text" id="cpc_card_number" name="cpc_card_number" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-secondary w-100">Proveri</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  {% endif %}
</div>
{% endblock %}
